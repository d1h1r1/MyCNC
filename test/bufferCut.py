from shapely.geometry import Polygon, LineString
import matplotlib.pyplot as plt
import numpy as np

# 外轮廓
outer = [
  [
    -25,
    -30,
    0
  ],
  [
    -25,
    30,
    0
  ],
  [
    25,
    30,
    0
  ],
  [
    25,
    -30,
    0
  ],
  [
    -25,
    -30,
    0
  ]
]

# 内槽（hole1）+ 小岛（hole2）
hole1 = [[-28.75688934326172, -8.54642391204834, 0], [-29.298614501953125, -6.449113368988037, 0], [-29.68759536743164, -4.318179607391357, 0], [-29.921798706054688, -2.1647326946258545, 0], [-30, 0, 0], [-29.921798706054688, 2.1647326946258545, 0], [-29.68759536743164, 4.318179607391357, 0], [-29.298614501953125, 6.449113368988037, 0], [-28.75688934326172, 8.54642391204834, 0], [-28.065235137939453, 10.599178314208984, 0], [-27.227264404296875, 12.596673011779785, 0], [-26.247337341308594, 14.528494834899902, 0], [-25.130577087402344, 16.384571075439453, 0], [-23.882789611816406, 18.15522575378418, 0], [-22.510494232177734, 19.831228256225586, 0], [-21.020835876464844, 21.403839111328125, 0], [-19.421588897705078, 22.8648624420166, 0], [-17.721084594726562, 24.206676483154297, 0], [-15.92818832397461, 25.42228889465332, 0], [-14.052253723144531, 26.505361557006836, 0], [-12.10305404663086, 27.450246810913086, 0], [-10.090755462646484, 28.25201988220215, 0], [-8.025848388671875, 28.9064998626709, 0], [-5.919101715087891, 29.410274505615234, 0], [-3.7814903259277344, 29.760717391967773, 0], [-1.624166488647461, 29.956003189086914, 0], [0.5416240692138672, 29.99510955810547, 0], [2.704591751098633, 29.877838134765625, 0], [4.853460311889648, 29.604795455932617, 0], [6.977024078369141, 29.17740821838379, 0], [9.064212799072266, 28.597902297973633, 0], [11.104145050048828, 27.869300842285156, 0], [13.086185455322266, 26.995403289794922, 0], [15, 25.980762481689453, 0], [16.83561134338379, 24.830669403076172, 0], [18.583450317382812, 23.551122665405273, 0], [20.234403610229492, 22.14879035949707, 0], [21.779865264892578, 20.630983352661133, 0], [23.211774826049805, 19.005617141723633, 0], [24.52267074584961, 17.281164169311523, 0], [25.70571517944336, 15.466615676879883, 0], [26.754743576049805, 13.571431159973145, 0], [27.664283752441406, 11.605491638183594, 0], [28.429595947265625, 9.579046249389648, 0], [29.046688079833984, 7.502659797668457, 0], [29.512346267700195, 5.387158393859863, 0], [29.824138641357422, 3.243570566177368, 0], [29.98044204711914, 1.0830724239349365, 0], [30, 1.1021821408568715e-14, 0], [29.98044204711914, -1.0830724239349365, 0], [29.824138641357422, -3.243570566177368, 0], [29.512346267700195, -5.387158393859863, 0], [29.046688079833984, -7.502659797668457, 0], [28.429595947265625, -9.579046249389648, 0], [27.664283752441406, -11.605491638183594, 0], [26.754743576049805, -13.571431159973145, 0], [25.70571517944336, -15.466615676879883, 0], [24.52267074584961, -17.281164169311523, 0], [23.211774826049805, -19.005617141723633, 0], [21.779865264892578, -20.630983352661133, 0], [20.234403610229492, -22.14879035949707, 0], [18.583450317382812, -23.551122665405273, 0], [16.83561134338379, -24.830669403076172, 0], [15, -25.980762481689453, 0], [13.086185455322266, -26.995403289794922, 0], [11.104145050048828, -27.869300842285156, 0], [9.064212799072266, -28.597902297973633, 0], [6.977024078369141, -29.17740821838379, 0], [4.853460311889648, -29.604795455932617, 0], [2.704591751098633, -29.877838134765625, 0], [0.5416240692138672, -29.99510955810547, 0], [-1.624166488647461, -29.956003189086914, 0], [-3.7814903259277344, -29.760717391967773, 0], [-5.919101715087891, -29.410274505615234, 0], [-8.025848388671875, -28.9064998626709, 0], [-10.090755462646484, -28.25201988220215, 0], [-12.10305404663086, -27.450246810913086, 0], [-14.052253723144531, -26.505361557006836, 0], [-15.92818832397461, -25.42228889465332, 0], [-17.721084594726562, -24.206676483154297, 0], [-19.421588897705078, -22.8648624420166, 0], [-21.020835876464844, -21.403839111328125, 0], [-22.510494232177734, -19.831228256225586, 0], [-23.882789611816406, -18.15522575378418, 0], [-25.130577087402344, -16.384571075439453, 0], [-26.247337341308594, -14.528494834899902, 0], [-27.227264404296875, -12.596673011779785, 0], [-28.065235137939453, -10.599178314208984, 0], [-28.75688934326172, -8.54642391204834, 0]]

# 创建型腔多边形
poly = Polygon(outer, [hole1])

# 扫掠线 step
step = 0.5
miny, maxy = poly.bounds[1], poly.bounds[3]
ys = np.arange(miny + step / 2, maxy, step)

# 生成刀轨（从下往上）
paths = []
for y in ys:
    line = LineString([(-1000, y), (1000, y)])
    if not poly.is_valid:
        print("Invalid polygon detected. Attempting to fix...")
        poly = poly.buffer(0)

    inter = poly.intersection(line)
    if inter.is_empty:
        continue
    elif inter.geom_type == 'LineString':
        paths.append(inter)
    elif inter.geom_type == 'MultiLineString':
        paths.extend(inter.geoms)

# 画图
fig, ax = plt.subplots()
x, y = poly.exterior.xy
ax.plot(x, y, 'k', label='轮廓')
for interior in poly.interiors:
    x, y = zip(*interior.coords)
    ax.plot(x, y, 'gray', linestyle='--', label='槽')

# 每条路径画出来
for i, path in enumerate(paths):
    x, y = path.xy
    ax.plot(x, y, 'r' if i % 2 == 0 else 'b')

ax.set_aspect('equal')
plt.title("避让槽的 Zig-Zag 铣削路径")
plt.legend()
plt.show()

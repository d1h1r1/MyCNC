import time

from opencamlib import ocl
import camvtk
import ngc_writer
import math
import shapely.affinity as sa
import shapely.geometry as sg
from shapely.affinity import scale

"""
创建一个简单的“Zig”图案，只在一个方向上切割。
# 第一行在ymin
# 最后一行是ymax
"""


def YdirectionZigPath(xmin, xmax, ymin, ymax, z_depth, Ny):
    paths = []
    dy = float(ymax - ymin) / (Ny - 1)  # the y step-over
    for n in range(0, Ny):
        path = ocl.Path()
        y = ymin + n * dy  # 当前y轴
        if n == Ny - 1:
            assert (y == ymax)
        elif n == 0:
            assert (y == ymin)
        p1 = ocl.Point(xmin, y, z_depth)  # 起始点
        p2 = ocl.Point(xmax, y, z_depth)  # 终点
        l = ocl.Line(p1, p2)  # 直线
        path.append(l)
        paths.append(path)
    return paths


# 双向锯齿
def YdirectionAlternatingZigPath(xmin, xmax, ymin, ymax, z_depth, Ny):
    paths = []
    dy = float(ymax - ymin) / (Ny - 1)  # y 步长
    for n in range(0, Ny):
        path = ocl.Path()
        y = ymin + n * dy  # 当前 y 坐标
        if n == Ny - 1:
            assert (y == ymax)
        elif n == 0:
            assert (y == ymin)
        p1 = ocl.Point(xmin, y, z_depth)  # 起始点
        p2 = ocl.Point(xmax, y, z_depth)  # 结束点

        if n % 2 == 0:  # 偶数行从左到右
            l = ocl.Line(p1, p2)
        else:  # 奇数行从右到左
            l = ocl.Line(p2, p1)

        path.append(l)
        paths.append(path)
    return paths


"""
螺旋路径1
这种路径适用于需要处理圆形区域的情况，像是孔的加工或者从外向内的轮廓铣削。
turns: 螺旋的圈数。
segments: 每圈的分段数，总分段数为 turns * segments。
从内到外
"""


def spiralPath(xmin, xmax, ymin, ymax, z_depth, turns, segments):
    center_x = (xmin + xmax) / 2
    center_y = (ymin + ymax) / 2
    max_radius = min((xmax - xmin) / 2, (ymax - ymin) / 2)
    total_segments = turns * segments
    angle_step = 2 * math.pi / segments  # 每个分段的角度增量
    radius_step = max_radius / total_segments  # 每个分段的半径增量
    paths = []  # 存储路径点
    for i in range(total_segments):
        path = ocl.Path()
        angle = i * angle_step  # 当前角度
        radius = i * radius_step  # 当前半径
        x = center_x + radius * math.cos(angle)
        y = center_y + radius * math.sin(angle)
        p = ocl.Point(x, y, z_depth)
        if i > 0:  # 从第二个点开始创建线段
            l = ocl.Line(prev_p, p)
            path.append(l)
        prev_p = p
        paths.append(path)
    return paths


"""
螺旋路径2
center_x:螺旋路径的中心 X 坐标
center_y:螺旋路径的中心 Y 坐标。
radius:螺旋的最大半径，定义路径的覆盖范围。
z_depth:刀具的切削深度（Z 轴位置）。
num_turns:螺旋的圈数，即路径从外到内的次数。
step_over:刀具每圈之间的间隔，用于控制路径密度（通常小于刀具直径）。
从外到内
"""


def SpiralPath(center_x, center_y, z_depth, radius, num_turns, step_over):
    paths = []
    theta_step = 2 * math.pi / 100  # 控制圆滑度（100 步每圈）
    for turn in range(num_turns):
        path = ocl.Path()
        for i in range(101):  # 101 点构成一圈
            theta = i * theta_step + turn * 2 * math.pi
            r = radius - turn * step_over  # 半径逐渐减小
            if r <= 0:  # 超出半径范围
                break
            x = center_x + r * math.cos(theta)
            y = center_y + r * math.sin(theta)
            z = z_depth
            p = ocl.Point(x, y, z_depth)
            if i > 0:  # 从第二个点开始创建线段
                l = ocl.Line(prev_p, p)
                path.append(l)
            prev_p = p
        paths.append(path)
    return paths


"""
从中心开始的螺旋路径
"""


def spiralOutPath(xmin, xmax, ymin, ymax, z_depth, layers):
    paths = []
    center_x = (xmin + xmax) / 2
    center_y = (ymin + ymax) / 2
    radius_step = min(xmax - xmin, ymax - ymin) / (2 * layers)
    for i in range(layers):
        path = ocl.Path()
        radius = radius_step * (i + 1)
        # path = []
        for angle in range(0, 360, 5):  # 每 5 度
            rad = math.radians(angle)
            x = center_x + radius * math.cos(rad)
            y = center_y + radius * math.sin(rad)
            p = ocl.Point(x, y, z_depth)
            if i > 0:  # 从第二个点开始创建线段
                l = ocl.Line(prev_p, p)
                path.append(l)
            prev_p = p
        paths.append(path)
    return paths


"""
平行偏移路径
polygon:描述初始区域的多边形顶点，表示要加工的封闭区域。
step_over:每次偏移的距离（通常小于刀具直径），控制路径的密集程度
"""


def OffsetPath(polygon, z_depth, step_over):
    original_polygon = sg.Polygon(polygon)  # 输入多边形
    paths = []
    current_polygon = original_polygon
    while not current_polygon.is_empty and current_polygon.area > 0:
        try:
            path = ocl.Path()
            coords = list(current_polygon.exterior.coords)  # 提取当前多边形外边界点
            for i in range(len(coords) - 1):  # 创建线段
                p1 = ocl.Point(coords[i][0], coords[i][1], z_depth)
                p2 = ocl.Point(coords[i + 1][0], coords[i + 1][1], z_depth)
                # p1 = ocl.Point(*coords[i] + z_depth, 0)
                # p2 = ocl.Point(*coords[i + 1] + z_depth, 0)
                l = ocl.Line(p1, p2)
                path.append(l)
            paths.append(path)
            # 偏移当前多边形
            current_polygon = current_polygon.buffer(-step_over, resolution=16)
        except Exception as e:
            print(e)
            pass
    return paths


"""
曲线跟随
curve_points: 曲线点列表（例如从矢量文件中读取）。
z_depth: 切削深度。
"""


def ContourPath(curve_points, z_depth):
    path = ocl.Path()
    for i in range(len(curve_points) - 1):
        p1 = ocl.Point(*curve_points[i], z_depth)
        p2 = ocl.Point(*curve_points[i + 1], z_depth)
        l = ocl.Line(p1, p2)
        path.append(l)
    p_start = ocl.Point(*curve_points[0], z_depth)
    p_end = ocl.Point(*curve_points[len(curve_points) - 1], z_depth)
    l_end = ocl.Line(p_end, p_start)
    path.append(l_end)
    return [path]


"""
混合路径 (Adaptive Clearing)
自适应清除路径会智能调整切削区域，保持恒定刀具负载，适合高效粗加工。

实现思路： 自适应路径需要不断计算刀具干涉和剩余材料区域，以下是一个简化版思路：

初始化加工区域为一个多边形。
刀具按固定步进（步距和深度）逐步侵入区域。
通过布尔运算计算剩余未加工区域。
根据未加工区域继续生成路径。

initial_region:初始加工区域，定义要清除的几何形状。
tool_diameter:刀具直径，用于计算路径与材料的干涉和刀具负载。
step_over:刀具之间的侧向重叠距离，影响路径密度。
max_depth:最大切削深度，用于控制单次加工的材料移除量。
"""


def AdaptivePath(initial_region, tool_diameter, step_over, max_depth):
    def generate_one_pass(region, tool_diameter, step_over, max_depth):
        # 确定步距：根据刀具直径和步进比例
        step_distance = tool_diameter * step_over
        current_region = region

        # 定义路径存储
        pass_path = []

        # 在区域内生成步进切割路径
        while current_region.area > 1:
            print(1, current_region.area)
            # 获取区域的边界
            boundary = current_region.exterior
            # 缩小区域以模拟刀具轨迹
            offset_region = sa.scale(boundary, xfact=(1 - step_over), yfact=(1 - step_over))
            # 更新路径
            # print(offset_region.area)
            pass_path.append(offset_region)
            # 减去切割过的部分
            current_region = sg.Polygon(offset_region)
            print(2, current_region.area)

        return pass_path

    def calculate_remaining_area(region, path, tool_diameter):
        # 将路径转换为多边形刀具区域
        tool_path = sg.Polygon(path)

        # 缩小刀具区域以模拟实际切割效果
        cut_area = tool_path.buffer(tool_diameter / 2.0)

        # 从当前区域中减去切割区域
        remaining_region = region.difference(cut_area)

        return remaining_region

    region = sg.Polygon(initial_region)
    paths = []
    # while region.area > 0:
    print(region.area)
    path = generate_one_pass(region, tool_diameter, step_over, max_depth)
    # paths.append(path)
    region = calculate_remaining_area(region, path, tool_diameter)
    print(region.area)
    # print(region.area)
    return paths


# 自适应避让刀路
def adaptive_path_drop_cutter(surface, cutter, paths):
    apdc = ocl.AdaptivePathDropCutter()
    # apdc = ocl.AdaptiveWaterline()
    # apdc = ocl.PathDropCutter()
    # apdc.setZ(-1)
    apdc.setSTL(surface)
    apdc.setCutter(cutter)
    apdc.setSampling(0.04)  # 最大采样或“步进”距离
    # 防止丢失STL模型的任何细节，这个数应该与最小的三角形相似或更小
    apdc.setMinSampling(0.01)  # 最小采样或“步进”距离
    # 该算法细分了工具路径的“陡峭”部分
    # 直到我们达到这个极限。

    cl_paths = []
    n_points = 0
    for path in paths:
        apdc.setPath(path)
        apdc.run()
        cl_points = apdc.getCLPoints()
        n_points = n_points + len(cl_points)
        cl_paths.append(cl_points)
    # print(cl_paths, n_points)
    return cl_paths, n_points


# 这可以是任意三角形的源
# 只要它产生一个我们可以使用的ocl.STLSurf（）
def STLSurfaceSource(filename):
    stl = camvtk.STLSurf(filename)
    polydata = stl.src.GetOutput()
    # print(polydata)
    s = ocl.STLSurf()
    camvtk.vtkPolyData2OCLSTL(polydata, s)
    return s


# 筛选单个路径
def filter_path(path, tol):
    f = ocl.LineCLFilter()
    f.setTolerance(tol)
    for p in path:
        p2 = ocl.CLPoint(p.x, p.y, p.z)
        f.addCLPoint(p2)
    f.run()
    return f.getCLPoints()


# 为了减少g代码的大小，我们在这里进行过滤。（这不是严格要求的，可以省略）
# 如果有过滤器的话，我们可以在这里检测到G2/G3电弧。
# 想法:
# 如果原始工具路径中有三个点（p1,p2,p3）
# 和点p2在直线p1-p3的容差范围内
# 然后我们将路径简化为（p1,p3）
def filterCLPaths(cl_paths, tolerance=0.001):
    cl_filtered_paths = []
    t_before = time.time()
    n_filtered = 0
    for cl_path in cl_paths:
        cl_filtered = filter_path(cl_path, tol)

        n_filtered = n_filtered + len(cl_filtered)
        cl_filtered_paths.append(cl_filtered)
    return cl_filtered_paths, n_filtered


# 使用ngc_writer并将g代码写入标准输出或文件
def write_zig_gcode_file(filename, n_triangles, t1, n1, tol, t2, n2, toolpath):
    ngc_writer.clearance_height = 10  # 安全高度
    ngc_writer.feed_height = 10  # 进刀高度
    ngc_writer.feed = 200  # 进给速度
    ngc_writer.plunge_feed = 100  # z轴进给速度
    ngc_writer.metric = True  # 公尺/英尺 flag
    ngc_writer.comment(" OpenCAMLib %s" % ocl.version())
    ngc_writer.comment(" STL surface: %s" % filename)
    ngc_writer.comment("   triangles: %d" % n_triangles)
    ngc_writer.comment(" OpenCAMLib::AdaptivePathDropCutter run took %.2f s" % t1)
    ngc_writer.comment(" got %d raw CL-points " % n1)
    ngc_writer.comment(" filtering to tolerance %.4f " % (tol))
    ngc_writer.comment(" got %d filtered CL-points. Filter done in %.3f s " % (n2, t2))
    ngc_writer.preamble()
    for path in toolpath:
        try:
            ngc_writer.pen_up()
            first_pt = path[0]
            ngc_writer.xy_rapid_to(first_pt.x, first_pt.y)
            ngc_writer.pen_down(first_pt.z)
            for p in path[1:]:
                ngc_writer.line_to(p.x, p.y, p.z)
        except:
            pass
    ngc_writer.postamble()  # 结束


# 图像可视化
def vtk_visualize_parallel_finish_zig(stlfile, toolpaths):
    myscreen = camvtk.VTKScreen()
    stl = camvtk.STLSurf(stlfile)
    myscreen.addActor(stl)
    stl.SetSurface()
    stl.SetColor(camvtk.cyan)
    # myscreen.camera.SetPosition(15, 13, 7)
    # myscreen.camera.SetFocalPoint(5, 5, 0)

    rapid_height = 10  # 安全高度
    feed_height = 10   # 进给高度
    rapidColor = camvtk.pink
    XYrapidColor = camvtk.green
    plungeColor = camvtk.red
    feedColor = camvtk.yellow
    pos = ocl.Point(0, 0, 0)
    first = True
    for path in toolpaths:
        try:
            first_pt = path[0]
            if first:  # 绿色球体表示开始位置
                myscreen.addActor(
                    camvtk.Sphere(center=(first_pt.x, first_pt.y, rapid_height), radius=0.1, color=camvtk.green))
                pos = ocl.Point(first_pt.x, first_pt.y,
                                first_pt.z)
                first = False
            else:
                # 回到进给高度
                myscreen.addActor(
                    camvtk.Line(p1=(pos.x, pos.y, pos.z), p2=(pos.x, pos.y, feed_height), color=plungeColor))
                myscreen.addActor(
                    camvtk.Line(p1=(pos.x, pos.y, feed_height), p2=(pos.x, pos.y, rapid_height), color=rapidColor))
                myscreen.addActor(
                    camvtk.Line(p1=(pos.x, pos.y, rapid_height), p2=(first_pt.x, first_pt.y, rapid_height),
                                color=XYrapidColor))
                pos = ocl.Point(first_pt.x, first_pt.y, first_pt.z)

            # 回到进给高度
            myscreen.addActor(
                camvtk.Line(p1=(pos.x, pos.y, rapid_height), p2=(pos.x, pos.y, feed_height), color=rapidColor))
            # 下降到加工高度
            myscreen.addActor(camvtk.Line(p1=(pos.x, pos.y, feed_height), p2=(pos.x, pos.y, pos.z), color=plungeColor))

            # 开始加工
            for p in path[1:]:
                myscreen.addActor(camvtk.Line(p1=(pos.x, pos.y, pos.z), p2=(p.x, p.y, p.z), color=feedColor))
                pos = ocl.Point(p.x, p.y, p.z)
        except:
            pass

    # 加工完成、回到安全高度
    myscreen.addActor(camvtk.Line(p1=(pos.x, pos.y, pos.z), p2=(pos.x, pos.y, feed_height), color=plungeColor))
    myscreen.addActor(camvtk.Line(p1=(pos.x, pos.y, feed_height), p2=(pos.x, pos.y, rapid_height), color=rapidColor))
    myscreen.addActor(camvtk.Sphere(center=(pos.x, pos.y, rapid_height), radius=0.1, color=camvtk.red))

    camvtk.drawArrows(myscreen, center=(-0.5, -0.5, -0.5))
    camvtk.drawOCLtext(myscreen)
    myscreen.render()
    myscreen.iren.Start()


if __name__ == "__main__":
    stlfile = "elephant.STL"
    # stlfile = "coin_half.stl"
    surface = STLSurfaceSource(stlfile)
    diameter = 3
    length = 50
    # cutter = ocl.BallCutter(diameter, length)             # 球刀
    cutter = ocl.CylCutter(diameter, length)          # 平底刀

    # corner_radius = 0.05
    # cutter = ocl.BullCutter(diameter, 0.2, length)        # 环形刀
    # angle = math.pi/4
    # cutter = ocl.ConeCutter(diameter, angle, length)      # 锥形刀
    # cutter = cutter.offsetCutter( 0.4 )

    ymin = -75
    ymax = 75
    xmin = -50
    xmax = 50
    z_depth = 5
    Ny = 50

    a2 = [(-10.60479736328125, -32.4033317565918), (-10.573566436767578, -32.71335220336914), (-10.573566436767578, -32.71335220336914), (-10.573566436767578, -32.71335220336914), (-10.573566436767578, -32.71335220336914), (-10.573566436767578, -32.71335220336914), (-10.573566436767578, -32.71335220336914), (-10.492622375488281, -33.01423645019531), (-10.492622375488281, -33.01423645019531), (-10.492622375488281, -33.01423645019531), (-10.492622375488281, -33.01423645019531), (-10.492622375488281, -33.01423645019531), (-10.492622375488281, -33.01423645019531), (-10.364055633544922, -33.29804229736328), (-10.364055633544922, -33.29804229736328), (-10.364055633544922, -33.29804229736328), (-10.364055633544922, -33.29804229736328), (-10.364055633544922, -33.29804229736328), (-10.364055633544922, -33.29804229736328), (-10.191261291503906, -33.55733871459961), (-10.191261291503906, -33.55733871459961), (-10.191261291503906, -33.55733871459961), (-10.191261291503906, -33.55733871459961), (-10.191261291503906, -33.55733871459961), (-10.191261291503906, -33.55733871459961), (-9.978832244873047, -33.7852668762207), (-9.978832244873047, -33.7852668762207), (-9.978832244873047, -33.7852668762207), (-9.978832244873047, -33.7852668762207), (-9.978832244873047, -33.7852668762207), (-9.978832244873047, -33.7852668762207), (-9.732303619384766, -33.97582244873047), (-9.732303619384766, -33.97582244873047), (-9.732303619384766, -33.97582244873047), (-9.732303619384766, -33.97582244873047), (-9.732303619384766, -33.97582244873047), (-9.732303619384766, -33.97582244873047), (-9.458183288574219, -34.124000549316406), (-9.458183288574219, -34.124000549316406), (-9.458183288574219, -34.124000549316406), (-9.458183288574219, -34.124000549316406), (-9.458183288574219, -34.124000549316406), (-9.458183288574219, -34.124000549316406), (-9.163738250732422, -34.22589111328125), (-9.163738250732422, -34.22589111328125), (-9.163738250732422, -34.22589111328125), (-9.163738250732422, -34.22589111328125), (-9.163738250732422, -34.22589111328125), (-9.163738250732422, -34.22589111328125), (-8.85665512084961, -34.27882385253906), (-8.85665512084961, -34.27882385253906), (-8.85665512084961, -34.27882385253906), (-8.85665512084961, -34.27882385253906), (-8.85665512084961, -34.27882385253906), (-8.85665512084961, -34.27882385253906), (-8.545101165771484, -34.2813835144043), (-8.545101165771484, -34.2813835144043), (-8.545101165771484, -34.2813835144043), (-8.545101165771484, -34.2813835144043), (-8.545101165771484, -34.2813835144043), (-8.545101165771484, -34.2813835144043), (-8.23724365234375, -34.2335090637207), (-8.23724365234375, -34.2335090637207), (-8.23724365234375, -34.2335090637207), (-8.23724365234375, -34.2335090637207), (-8.23724365234375, -34.2335090637207), (-8.23724365234375, -34.2335090637207), (-7.941127777099609, -34.136470794677734), (-7.941127777099609, -34.136470794677734), (-7.941127777099609, -34.136470794677734), (-7.941127777099609, -34.136470794677734), (-7.941127777099609, -34.136470794677734), (-7.941127777099609, -34.136470794677734), (-7.941127777099609, -34.136470794677734), (-7.941127777099609, -34.136470794677734), (-7.941127777099609, -34.136470794677734), (-7.941127777099609, -34.136470794677734), (-7.941127777099609, -34.136470794677734), (-7.941127777099609, -34.136470794677734), (-4.010379791259766, -32.23027038574219), (-4.010379791259766, -32.23027038574219), (-4.010379791259766, -32.23027038574219), (-4.010379791259766, -32.23027038574219), (-4.010379791259766, -32.23027038574219), (-4.010379791259766, -32.23027038574219), (-0.3801002502441406, -29.948589324951172), (-0.3801002502441406, -29.948589324951172), (-0.3801002502441406, -29.948589324951172), (-0.3801002502441406, -29.948589324951172), (-0.3801002502441406, -29.948589324951172), (-0.3801002502441406, -29.948589324951172), (2.9245033264160156, -27.31491470336914), (2.9245033264160156, -27.31491470336914), (2.9245033264160156, -27.31491470336914), (2.9245033264160156, -27.31491470336914), (2.9245033264160156, -27.31491470336914), (2.9245033264160156, -27.31491470336914), (5.901634216308594, -24.33739471435547), (5.901634216308594, -24.33739471435547), (5.901634216308594, -24.33739471435547), (5.901634216308594, -24.33739471435547), (5.901634216308594, -24.33739471435547), (5.901634216308594, -24.33739471435547), (8.56781005859375, -21.00374984741211), (8.56781005859375, -21.00374984741211), (8.56781005859375, -21.00374984741211), (8.56781005859375, -21.00374984741211), (8.56781005859375, -21.00374984741211), (8.56781005859375, -21.00374984741211), (10.866046905517578, -17.41881561279297), (10.866046905517578, -17.41881561279297), (10.866046905517578, -17.41881561279297), (10.866046905517578, -17.41881561279297), (10.866046905517578, -17.41881561279297), (10.866046905517578, -17.41881561279297), (11.452495574951172, -16.364704132080078), (11.452495574951172, -16.364704132080078), (11.874614715576172, -15.399051666259766), (11.874614715576172, -15.399051666259766), (11.874614715576172, -15.399051666259766), (11.874614715576172, -15.399051666259766), (11.874614715576172, -15.399051666259766), (11.874614715576172, -15.399051666259766), (12.132644653320312, -14.377189636230469), (12.132644653320312, -14.377189636230469), (12.132644653320312, -14.377189636230469), (12.132644653320312, -14.377189636230469), (12.132644653320312, -14.377189636230469), (12.132644653320312, -14.377189636230469), (12.219371795654297, -13.326866149902344), (12.219371795654297, -13.326866149902344), (12.219371795654297, -13.326866149902344), (12.219371795654297, -13.326866149902344), (12.219371795654297, 55.40940856933594), (12.219371795654297, 55.40940856933594), (12.219371795654297, 55.40940856933594), (12.219371795654297, 55.40940856933594), (12.219371795654297, -13.326866149902344), (12.219371795654297, -13.326866149902344), (12.052238464355469, 57.42645263671875), (12.052238464355469, 57.42645263671875), (12.219371795654297, 55.40940856933594), (12.219371795654297, 55.40940856933594), (12.052238464355469, 57.42645263671875), (12.052238464355469, 57.42645263671875), (11.555374145507812, 59.38848876953125), (11.555374145507812, 59.38848876953125), (12.052238464355469, 57.42645263671875), (12.052238464355469, 57.42645263671875), (11.555374145507812, 59.38848876953125), (11.555374145507812, 59.38848876953125), (10.742366790771484, 61.241973876953125), (10.742366790771484, 61.241973876953125), (11.555374145507812, 59.38848876953125), (11.555374145507812, 59.38848876953125), (10.742366790771484, 61.241973876953125), (10.742366790771484, 61.241973876953125), (9.635387420654297, 62.936370849609375), (9.635387420654297, 62.936370849609375), (10.742366790771484, 61.241973876953125), (10.742366790771484, 61.241973876953125), (9.635387420654297, 62.936370849609375), (9.635387420654297, 62.936370849609375), (8.264602661132812, 64.42544555664062), (8.264602661132812, 64.42544555664062), (9.635387420654297, 62.936370849609375), (9.635387420654297, 62.936370849609375), (8.264602661132812, 64.42544555664062), (8.264602661132812, 64.42544555664062), (6.667377471923828, 65.66859436035156), (6.667377471923828, 65.66859436035156), (8.264602661132812, 64.42544555664062), (8.264602661132812, 64.42544555664062), (6.667377471923828, 65.66859436035156), (6.667377471923828, 65.66859436035156), (4.887401580810547, 66.63188171386719), (4.887401580810547, 66.63188171386719), (6.667377471923828, 65.66859436035156), (6.667377471923828, 65.66859436035156), (4.887401580810547, 66.63188171386719), (4.887401580810547, 66.63188171386719), (2.9730796813964844, 67.28907775878906), (2.9730796813964844, 67.28907775878906), (4.887401580810547, 66.63188171386719), (4.887401580810547, 66.63188171386719), (2.9730796813964844, 67.28907775878906), (2.9730796813964844, 67.28907775878906), (0.9767417907714844, 67.62220764160156), (0.9767417907714844, 67.62220764160156), (2.9730796813964844, 67.28907775878906), (2.9730796813964844, 67.28907775878906), (0.9767417907714844, 67.62220764160156), (0.9767417907714844, 67.62220764160156), (-1.0472526550292969, 67.62220764160156), (-1.0472526550292969, 67.62220764160156), (0.9767417907714844, 67.62220764160156), (0.9767417907714844, 67.62220764160156), (-1.0472526550292969, 67.62220764160156), (-1.0472526550292969, 67.62220764160156), (-3.043590545654297, 67.28907775878906), (-3.043590545654297, 67.28907775878906), (-1.0472526550292969, 67.62220764160156), (-1.0472526550292969, 67.62220764160156), (-3.043590545654297, 67.28907775878906), (-3.043590545654297, 67.28907775878906), (-4.957912445068359, 66.63188171386719), (-4.957912445068359, 66.63188171386719), (-3.043590545654297, 67.28907775878906), (-3.043590545654297, 67.28907775878906), (-4.957912445068359, 66.63188171386719), (-4.957912445068359, 66.63188171386719), (-6.737945556640625, 65.66859436035156), (-6.737945556640625, 65.66859436035156), (-4.957912445068359, 66.63188171386719), (-4.957912445068359, 66.63188171386719), (-6.737945556640625, 65.66859436035156), (-6.737945556640625, 65.66859436035156), (-8.335113525390625, 64.42544555664062), (-8.335113525390625, 64.42544555664062), (-6.737945556640625, 65.66859436035156), (-6.737945556640625, 65.66859436035156), (-8.335113525390625, 64.42544555664062), (-8.335113525390625, 64.42544555664062), (-9.705902099609375, 62.936370849609375), (-9.705902099609375, 62.936370849609375), (-8.335113525390625, 64.42544555664062), (-8.335113525390625, 64.42544555664062), (-9.705902099609375, 62.936370849609375), (-9.705902099609375, 62.936370849609375), (-10.812877655029297, 61.241973876953125), (-10.812877655029297, 61.241973876953125), (-9.705902099609375, 62.936370849609375), (-9.705902099609375, 62.936370849609375), (-10.812877655029297, 61.241973876953125), (-10.812877655029297, 61.241973876953125), (-11.625946044921875, 59.38848876953125), (-11.625946044921875, 59.38848876953125), (-10.812877655029297, 61.241973876953125), (-10.812877655029297, 61.241973876953125), (-11.625946044921875, 59.38848876953125), (-11.625946044921875, 59.38848876953125), (-12.122749328613281, 57.42645263671875), (-12.122749328613281, 57.42645263671875), (-11.625946044921875, 59.38848876953125), (-11.625946044921875, 59.38848876953125), (-12.122749328613281, 57.42645263671875), (-12.122749328613281, 57.42645263671875), (-12.28988265991211, 55.40940856933594), (-12.28988265991211, 55.40940856933594), (-12.28988265991211, 55.40940856933594), (-12.122749328613281, 57.42645263671875), (-12.122749328613281, 57.42645263671875), (-12.28988265991211, 55.40940856933594), (-12.28988265991211, 55.40940856933594), (-12.28988265991211, 55.40940856933594), (-12.28988265991211, 55.40940856933594), (-12.28988265991211, 55.40940856933594), (-12.28988265991211, 55.40940856933594), (-10.60479736328125, -32.4033317565918), (-12.28988265991211, 55.40940856933594), (-12.28988265991211, 55.40940856933594), (-12.28988265991211, 55.40940856933594)]

    a3 = [(38.393375396728516, 32.718299865722656), (38.304683685302734, 33.780059814453125), (38.304683685302734, 33.780059814453125), (38.304683685302734, 33.780059814453125), (38.304683685302734, 33.780059814453125), (38.304683685302734, 33.780059814453125), (38.304683685302734, 33.780059814453125), (38.04108810424805, 34.81239318847656), (38.04108810424805, 34.81239318847656), (38.04108810424805, 34.81239318847656), (38.04108810424805, 34.81239318847656), (38.04108810424805, 34.81239318847656), (38.04108810424805, 34.81239318847656), (37.60984420776367, 35.78669738769531), (37.60984420776367, 35.78669738769531), (37.60984420776367, 35.78669738769531), (37.60984420776367, 35.78669738769531), (37.60984420776367, 35.78669738769531), (37.60984420776367, 35.78669738769531), (37.02297592163086, 36.67595672607422), (37.02297592163086, 36.67595672607422), (37.02297592163086, 36.67595672607422), (37.02297592163086, 36.67595672607422), (37.02297592163086, 36.67595672607422), (37.02297592163086, 36.67595672607422), (36.296695709228516, 37.455528259277344), (36.296695709228516, 37.455528259277344), (36.296695709228516, 37.455528259277344), (36.296695709228516, 37.455528259277344), (36.296695709228516, 37.455528259277344), (36.296695709228516, 37.455528259277344), (35.45114517211914, 38.10380554199219), (35.45114517211914, 38.10380554199219), (35.45114517211914, 38.10380554199219), (35.45114517211914, 38.10380554199219), (21.667926788330078, 46.95335388183594), (21.667926788330078, 46.95335388183594), (35.45114517211914, 38.10380554199219), (35.45114517211914, 38.10380554199219), (21.667926788330078, 46.95335388183594), (21.667926788330078, 46.95335388183594), (21.667926788330078, 46.95335388183594), (21.667926788330078, 46.95335388183594), (21.38895034790039, 47.101593017578125), (21.38895034790039, 47.101593017578125), (21.38895034790039, 47.101593017578125), (21.38895034790039, 47.101593017578125), (21.38895034790039, 47.101593017578125), (21.38895034790039, 47.101593017578125), (21.089405059814453, 47.20207977294922), (21.089405059814453, 47.20207977294922), (21.089405059814453, 47.20207977294922), (21.089405059814453, 47.20207977294922), (21.089405059814453, 47.20207977294922), (21.089405059814453, 47.20207977294922), (20.777462005615234, 47.2520751953125), (20.777462005615234, 47.2520751953125), (20.777462005615234, 47.2520751953125), (20.777462005615234, 47.2520751953125), (20.777462005615234, 47.2520751953125), (20.777462005615234, 47.2520751953125), (20.461528778076172, 47.25023651123047), (20.461528778076172, 47.25023651123047), (20.461528778076172, 47.25023651123047), (20.461528778076172, 47.25023651123047), (20.461528778076172, 47.25023651123047), (20.461528778076172, 47.25023651123047), (20.150188446044922, 47.196624755859375), (20.150188446044922, 47.196624755859375), (20.150188446044922, 47.196624755859375), (20.150188446044922, 47.196624755859375), (20.150188446044922, 47.196624755859375), (20.150188446044922, 47.196624755859375), (19.85183334350586, 47.09266662597656), (19.85183334350586, 47.09266662597656), (19.85183334350586, 47.09266662597656), (19.85183334350586, 47.09266662597656), (19.85183334350586, 47.09266662597656), (19.85183334350586, 47.09266662597656), (19.574581146240234, 46.941192626953125), (19.574581146240234, 46.941192626953125), (19.574581146240234, 46.941192626953125), (19.574581146240234, 46.941192626953125), (19.574581146240234, 46.941192626953125), (19.574581146240234, 46.941192626953125), (19.325916290283203, 46.746307373046875), (19.325916290283203, 46.746307373046875), (19.325916290283203, 46.746307373046875), (19.325916290283203, 46.746307373046875), (19.325916290283203, 46.746307373046875), (19.325916290283203, 46.746307373046875), (19.112590789794922, 46.513275146484375), (19.112590789794922, 46.513275146484375), (19.112590789794922, 46.513275146484375), (19.112590789794922, 46.513275146484375), (19.112590789794922, 46.513275146484375), (19.112590789794922, 46.513275146484375), (18.940326690673828, 46.2484130859375), (18.940326690673828, 46.2484130859375), (18.940326690673828, 46.2484130859375), (18.940326690673828, 46.2484130859375), (18.940326690673828, 46.2484130859375), (18.940326690673828, 46.2484130859375), (18.81387710571289, 45.958900451660156), (18.81387710571289, 45.958900451660156), (18.81387710571289, 45.958900451660156), (18.81387710571289, 45.958900451660156), (18.81387710571289, 45.958900451660156), (18.81387710571289, 45.958900451660156), (18.73659896850586, 45.652565002441406), (18.73659896850586, 45.652565002441406), (18.73659896850586, 45.652565002441406), (18.73659896850586, 45.652565002441406), (18.73659896850586, 45.652565002441406), (18.73659896850586, 45.652565002441406), (18.710613250732422, 45.33769226074219), (18.710613250732422, 45.33769226074219), (18.710613250732422, 45.33769226074219), (18.710613250732422, 45.33769226074219), (18.710613250732422, -1.8503799438476562), (18.710613250732422, -1.8503799438476562), (18.710613250732422, 45.33769226074219), (18.710613250732422, 45.33769226074219), (18.710613250732422, -1.8503799438476562), (18.710613250732422, -1.8503799438476562), (18.710613250732422, -1.8503799438476562), (18.710613250732422, -1.8503799438476562), (18.739429473876953, -2.1818695068359375), (18.739429473876953, -2.1818695068359375), (18.739429473876953, -2.1818695068359375), (18.739429473876953, -2.1818695068359375), (18.825054168701172, -2.5033950805664062), (18.825054168701172, -2.5033950805664062), (18.739429473876953, -2.1818695068359375), (18.739429473876953, -2.1818695068359375), (18.825054168701172, -2.5033950805664062), (18.825054168701172, -2.5033950805664062), (18.964916229248047, -2.8053054809570312), (18.964916229248047, -2.8053054809570312), (18.825054168701172, -2.5033950805664062), (18.825054168701172, -2.5033950805664062), (18.964916229248047, -2.8053054809570312), (18.964916229248047, -2.8053054809570312), (19.154788970947266, -3.0785446166992188), (19.154788970947266, -3.0785446166992188), (18.964916229248047, -2.8053054809570312), (18.964916229248047, -2.8053054809570312), (19.154788970947266, -3.0785446166992188), (19.154788970947266, -3.0785446166992188), (19.38900375366211, -3.3148956298828125), (19.38900375366211, -3.3148956298828125), (19.154788970947266, -3.0785446166992188), (19.154788970947266, -3.0785446166992188), (19.38900375366211, -3.3148956298828125), (19.38900375366211, -3.3148956298828125), (19.660472869873047, -3.5072708129882812), (19.660472869873047, -3.5072708129882812), (19.38900375366211, -3.3148956298828125), (19.38900375366211, -3.3148956298828125), (19.660472869873047, -3.5072708129882812), (19.660472869873047, -3.5072708129882812), (19.961116790771484, -3.649871826171875), (19.961116790771484, -3.649871826171875), (19.660472869873047, -3.5072708129882812), (19.660472869873047, -3.5072708129882812), (19.961116790771484, -3.649871826171875), (19.961116790771484, -3.649871826171875), (20.281848907470703, -3.7384414672851562), (20.281848907470703, -3.7384414672851562), (19.961116790771484, -3.649871826171875), (19.961116790771484, -3.649871826171875), (20.281848907470703, -3.7384414672851562), (20.281848907470703, -3.7384414672851562), (20.613048553466797, -3.7703018188476562), (20.613048553466797, -3.7703018188476562), (20.281848907470703, -3.7384414672851562), (20.281848907470703, -3.7384414672851562), (20.613048553466797, -3.7703018188476562), (20.613048553466797, -3.7703018188476562), (20.944774627685547, -3.7445068359375), (20.944774627685547, -3.7445068359375), (20.613048553466797, -3.7703018188476562), (20.613048553466797, -3.7703018188476562), (20.944774627685547, -3.7445068359375), (20.944774627685547, -3.7445068359375), (21.267086029052734, -3.6618194580078125), (21.267086029052734, -3.6618194580078125), (20.944774627685547, -3.7445068359375), (20.944774627685547, -3.7445068359375), (21.267086029052734, -3.6618194580078125), (21.267086029052734, -3.6618194580078125), (21.570262908935547, -3.5247344970703125), (21.570262908935547, -3.5247344970703125), (21.267086029052734, -3.6618194580078125), (21.267086029052734, -3.6618194580078125), (21.570262908935547, -3.5247344970703125), (21.570262908935547, -3.5247344970703125), (21.845218658447266, -3.3373641967773438), (21.845218658447266, -3.3373641967773438), (21.570262908935547, -3.5247344970703125), (21.570262908935547, -3.5247344970703125), (21.845218658447266, -3.3373641967773438), (21.845218658447266, -3.3373641967773438), (36.04209518432617, 8.259208679199219), (36.04209518432617, 8.259208679199219), (36.04209518432617, 8.259208679199219), (36.04209518432617, 8.259208679199219), (21.845218658447266, -3.3373641967773438), (21.845218658447266, -3.3373641967773438), (36.72722244262695, 8.908744812011719), (36.72722244262695, 8.908744812011719), (36.04209518432617, 8.259208679199219), (36.04209518432617, 8.259208679199219), (36.72722244262695, 8.908744812011719), (36.72722244262695, 8.908744812011719), (37.309322357177734, 9.652000427246094), (37.309322357177734, 9.652000427246094), (36.72722244262695, 8.908744812011719), (36.72722244262695, 8.908744812011719), (37.309322357177734, 9.652000427246094), (37.309322357177734, 9.652000427246094), (37.775753021240234, 10.472793579101562), (37.775753021240234, 10.472793579101562), (37.309322357177734, 9.652000427246094), (37.309322357177734, 9.652000427246094), (37.775753021240234, 10.472793579101562), (37.775753021240234, 10.472793579101562), (38.11636734008789, 11.353279113769531), (38.11636734008789, 11.353279113769531), (37.775753021240234, 10.472793579101562), (37.775753021240234, 10.472793579101562), (38.11636734008789, 11.353279113769531), (38.11636734008789, 11.353279113769531), (38.323734283447266, 12.274299621582031), (38.323734283447266, 12.274299621582031), (38.11636734008789, 11.353279113769531), (38.11636734008789, 11.353279113769531), (38.323734283447266, 12.274299621582031), (38.323734283447266, 12.274299621582031), (38.393375396728516, 13.215797424316406), (38.393375396728516, 13.215797424316406), (38.323734283447266, 12.274299621582031), (38.323734283447266, 12.274299621582031), (38.393375396728516, 13.215797424316406), (38.393375396728516, 13.215797424316406), (38.393375396728516, 31.48664093017578), (38.393375396728516, 31.48664093017578), (38.393375396728516, 31.48664093017578), (38.393375396728516, 31.48664093017578), (38.393375396728516, 31.48664093017578), (38.393375396728516, 31.48664093017578), (38.393375396728516, 13.215797424316406), (38.393375396728516, 13.215797424316406), (38.393375396728516, 31.48664093017578), (38.393375396728516, 31.48664093017578), (38.393375396728516, 31.48664093017578), (38.393375396728516, 32.718299865722656), (38.393375396728516, 31.48664093017578), (38.393375396728516, 31.48664093017578), (38.393375396728516, 31.48664093017578)]

    b1 = [(-45.45706558227539, -66.7757797241211), (-45.45706558227539, -66.7757797241211), (-45.45706558227539, -66.7757797241211), (-45.45706558227539, -66.7757797241211), (-45.45706558227539, -66.7757797241211), (-45.45706558227539, -66.7757797241211), (-45.45706558227539, -50.775779724121094), (-45.45706558227539, -50.775779724121094), (-45.45706558227539, -50.775779724121094), (-45.45706558227539, -50.775779724121094), (-45.45706558227539, -50.775779724121094), (-45.45706558227539, -50.775779724121094), (-45.45706558227539, -50.775779724121094), (-45.45706558227539, -50.775779724121094), (-45.45706558227539, -50.775779724121094), (-45.45706558227539, -50.775779724121094), (-45.45706558227539, -50.775779724121094), (-45.45706558227539, -50.775779724121094), (-36.381065368652344, -50.775779724121094), (-36.381065368652344, -50.775779724121094), (-45.45706558227539, -50.775779724121094), (-45.45706558227539, -50.775779724121094), (-45.45706558227539, -50.775779724121094), (-45.45706558227539, -50.775779724121094), (-45.45706558227539, -50.775779724121094), (-45.45706558227539, -50.775779724121094), (-45.45706558227539, -50.775779724121094), (-45.45706558227539, -50.775779724121094), (-36.381065368652344, -50.775779724121094), (-36.381065368652344, -50.775779724121094), (-36.381065368652344, -50.775779724121094), (-36.381065368652344, -50.775779724121094), (-36.381065368652344, -52.55356216430664), (-36.381065368652344, -52.55356216430664), (-36.381065368652344, -52.55356216430664), (-36.381065368652344, -52.55356216430664), (-36.381065368652344, -52.55356216430664), (-36.381065368652344, -52.55356216430664), (-36.381065368652344, -52.55356216430664), (-36.381065368652344, -52.55356216430664), (-36.381065368652344, -52.55356216430664), (-36.381065368652344, -52.55356216430664), (-36.381065368652344, -52.55356216430664), (-36.381065368652344, -52.55356216430664), (-43.30503845214844, -52.55356216430664), (-43.30503845214844, -52.55356216430664), (-43.30503845214844, -52.55356216430664), (-43.30503845214844, -52.55356216430664), (-43.30503845214844, -52.55356216430664), (-43.30503845214844, -52.55356216430664), (-43.30503845214844, -52.55356216430664), (-43.30503845214844, -52.55356216430664), (-43.30503845214844, -52.55356216430664), (-43.30503845214844, -57.51262283325195), (-43.30503845214844, -57.51262283325195), (-43.30503845214844, -52.55356216430664), (-43.30503845214844, -52.55356216430664), (-43.30503845214844, -52.55356216430664), (-43.30503845214844, -57.51262283325195), (-43.30503845214844, -57.51262283325195), (-43.30503845214844, -57.51262283325195), (-36.942481994628906, -57.51262283325195), (-43.30503845214844, -57.51262283325195), (-36.942481994628906, -57.51262283325195), (-36.942481994628906, -57.51262283325195), (-36.942481994628906, -57.51262283325195), (-36.942481994628906, -57.51262283325195), (-36.942481994628906, -57.51262283325195), (-36.942481994628906, -59.2904052734375), (-36.942481994628906, -59.2904052734375), (-36.942481994628906, -57.51262283325195), (-36.942481994628906, -57.51262283325195), (-36.942481994628906, -57.51262283325195), (-36.942481994628906, -57.51262283325195), (-36.942481994628906, -57.51262283325195), (-36.942481994628906, -57.51262283325195), (-36.942481994628906, -59.2904052734375), (-36.942481994628906, -59.2904052734375), (-43.30503845214844, -59.2904052734375), (-43.30503845214844, -59.2904052734375), (-43.30503845214844, -59.2904052734375), (-36.942481994628906, -59.2904052734375), (-36.942481994628906, -59.2904052734375), (-43.30503845214844, -59.2904052734375), (-43.30503845214844, -59.2904052734375), (-43.30503845214844, -59.2904052734375), (-43.30503845214844, -64.99801635742188), (-43.30503845214844, -64.99801635742188), (-43.30503845214844, -59.2904052734375), (-43.30503845214844, -59.2904052734375), (-43.30503845214844, -59.2904052734375), (-43.30503845214844, -59.2904052734375), (-43.30503845214844, -59.2904052734375), (-43.30503845214844, -59.2904052734375), (-43.30503845214844, -64.99801635742188), (-43.30503845214844, -64.99801635742188), (-35.913230895996094, -64.99801635742188), (-35.913230895996094, -64.99801635742188), (-35.913230895996094, -64.99801635742188), (-43.30503845214844, -64.99801635742188), (-43.30503845214844, -64.99801635742188), (-35.913230895996094, -64.99801635742188), (-35.913230895996094, -64.99801635742188), (-35.913230895996094, -64.99801635742188), (-35.913230895996094, -66.7757797241211), (-35.913230895996094, -66.7757797241211), (-35.913230895996094, -64.99801635742188), (-35.913230895996094, -64.99801635742188), (-35.913230895996094, -64.99801635742188), (-35.913230895996094, -64.99801635742188), (-35.913230895996094, -64.99801635742188), (-35.913230895996094, -64.99801635742188), (-35.913230895996094, -66.7757797241211), (-35.913230895996094, -66.7757797241211), (-45.45706558227539, -66.7757797241211), (-45.45706558227539, -66.7757797241211), (-45.45706558227539, -66.7757797241211), (-35.913230895996094, -66.7757797241211), (-35.913230895996094, -66.7757797241211), (-45.45706558227539, -66.7757797241211), (-45.45706558227539, -66.7757797241211), (-45.45706558227539, -66.7757797241211)]

    paths = YdirectionZigPath(xmin, xmax, ymin, ymax, z_depth, Ny)  # 单向锯齿
    # paths = YdirectionAlternatingZigPath(xmin, xmax, ymin, ymax, z_depth, Ny)  # 双向锯齿
    # paths = spiralPath(xmin, xmax, ymin, ymax, z_depth, 10, 10)  # 螺旋路径1，从内到外
    # paths = SpiralPath(0, 0, z_depth, 50, 25, 2)  # 螺旋路径2，从外向内, 不连续圆
    # paths = spiralOutPath(xmin, xmax, ymin, ymax, z_depth, 50)  # 螺旋路径3, 从外向内, 连续圆
    # paths = OffsetPath(a2, z_depth, 1)  # 平行偏移路径
    # paths = ContourPath(b1, z_depth)  # 曲线跟随
    # paths = AdaptivePath([(40, 40), (60, 60), (61, 133), (50, 148), (37, 130)], 3, 0.5, 1)  # 自适应混合路径

    t_before = time.time()

    (raw_toolpath, n_raw) = adaptive_path_drop_cutter(surface, cutter, paths)
    t1 = time.time() - t_before

    tol = 0.001
    (toolpaths, n_filtered) = filterCLPaths(raw_toolpath, tolerance=0.001)
    t2 = time.time() - t_before

    write_zig_gcode_file(stlfile, surface.size(), t1, n_raw, tol, t2, n_filtered, toolpaths)
    vtk_visualize_parallel_finish_zig(stlfile, toolpaths)

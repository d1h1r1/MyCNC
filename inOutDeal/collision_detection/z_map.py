import time

import numpy as np
from math import floor

import trimesh
from matplotlib import pyplot as plt


class ZMap:
    def __init__(self, xmin, ymin, xmax, ymax, step):
        self.step = step
        self.inv_step = 1.0 / step

        self.xmin = xmin
        self.ymin = ymin

        self.nx = int((xmax - xmin) * self.inv_step) + 1
        self.ny = int((ymax - ymin) * self.inv_step) + 1

        # 每个格子存最大 Z
        self.z = np.full((self.nx, self.ny), -1e9, dtype=np.float32)

    def xy_to_ij(self, x, y):
        ix = int((x - self.xmin) * self.inv_step)
        iy = int((y - self.ymin) * self.inv_step)
        return ix, iy


def barycentric(p, a, b, c):
    v0 = b - a
    v1 = c - a
    v2 = p - a

    d00 = np.dot(v0, v0)
    d01 = np.dot(v0, v1)
    d11 = np.dot(v1, v1)
    d20 = np.dot(v2, v0)
    d21 = np.dot(v2, v1)

    denom = d00 * d11 - d01 * d01
    if denom == 0:
        return None

    v = (d11 * d20 - d01 * d21) / denom
    w = (d00 * d21 - d01 * d20) / denom
    u = 1.0 - v - w
    return u, v, w


def rasterize_triangle(zmap: ZMap, tri):
    """
    tri: [(x,y,z), (x,y,z), (x,y,z)]
    """

    p0 = np.array(tri[0], dtype=np.float32)
    p1 = np.array(tri[1], dtype=np.float32)
    p2 = np.array(tri[2], dtype=np.float32)

    # XY 包围盒
    xmin = min(p0[0], p1[0], p2[0])
    xmax = max(p0[0], p1[0], p2[0])
    ymin = min(p0[1], p1[1], p2[1])
    ymax = max(p0[1], p1[1], p2[1])

    ix0, iy0 = zmap.xy_to_ij(xmin, ymin)
    ix1, iy1 = zmap.xy_to_ij(xmax, ymax)

    ix0 = max(ix0, 0)
    iy0 = max(iy0, 0)
    ix1 = min(ix1, zmap.nx - 1)
    iy1 = min(iy1, zmap.ny - 1)

    a = p0[:2]
    b = p1[:2]
    c = p2[:2]

    for ix in range(ix0, ix1 + 1):
        x = zmap.xmin + ix * zmap.step
        for iy in range(iy0, iy1 + 1):
            y = zmap.ymin + iy * zmap.step

            bc = barycentric(
                np.array([x, y], dtype=np.float32),
                a, b, c
            )
            if bc is None:
                continue

            u, v, w = bc
            if u < 0 or v < 0 or w < 0:
                continue

            z = u * p0[2] + v * p1[2] + w * p2[2]

            if z > zmap.z[ix, iy]:
                zmap.z[ix, iy] = z


def build_zmap(zmap: ZMap, triangles):
    for tri in triangles:
        rasterize_triangle(zmap, tri)


def shank_samples(radius):
    r = radius
    s = r * 0.70710678
    return [
        (r, 0), (-r, 0),
        (0, r), (0, -r),
        (s, s), (s, -s),
        (-s, s), (-s, -s)
    ]


def check_shank_collision(
        zmap: ZMap,
        x, y, z_tool,
        shank_len,
        shank_radius,
        clearance=0.0
):
    z_shank_bottom = z_tool - shank_len
    samples = shank_samples(shank_radius)

    for dx, dy in samples:
        ix, iy = zmap.xy_to_ij(x + dx, y + dy)

        if ix < 0 or iy < 0 or ix >= zmap.nx or iy >= zmap.ny:
            continue

        if z_shank_bottom < zmap.z[ix, iy] + clearance:
            return True

    return False


def check_toolpath(
        zmap: ZMap,
        toolpath,
        shank_len,
        shank_radius,
        clearance=0.1
):
    collision_indices = []

    for i, (x, y, z) in enumerate(toolpath):
        if check_shank_collision(
                zmap,
                x, y, z,
                shank_len,
                shank_radius,
                clearance
        ):
            collision_indices.append(i)

    return collision_indices


# 1. 模型三角形（示例）
# triangles = [
#     [(0, 0, 0), (10, 0, 0), (0, 10, 5)],
#     [(10, 0, 0), (10, 10, 5), (0, 10, 5)]
# ]

t1 = time.time()
# mesh = trimesh.load("../../file/多特征测试件01.STL")
mesh = trimesh.load("test.stl")
# 2. 计算模型包围盒
xmin, ymin, zmin = mesh.bounds[0]
xmax, ymax, zmax = mesh.bounds[1]

# 3. Z-Map 参数
tool_radius = 2
clearance = 0.5
step = 10


pad = tool_radius + clearance
# 2. 建 Z-Map
# zmap = ZMap(
#     xmin=0, ymin=0,
#     xmax=10, ymax=10,
#     step=0.1
# )

# 4. 建 Z-Map
zmap = ZMap(
    xmin=xmin - pad,
    ymin=ymin - pad,
    xmax=xmax + pad,
    ymax=ymax + pad,
    step=step
)

# 5. 填充 Z-Map
build_zmap(zmap, mesh.triangles)

# 3. 刀路
toolpath = [[-44, 16.04], [-44, 16.541], [-44, 17.088], [-44, 17.73], [-44, 18.44], [-44, 19.366], [-44, 23.248], [-44, 24.439], [-44, 25.235], [-44, 26.016], [-44, 26.797], [-44, 27.606], [-44, 28.668], [-44, 32.322], [-44, 33.435], [-44, 34.277], [-44, 35.119], [-44, 35.961], [-44, 36.803], [-44, 37.846], [-44, 40.843], [-44, 41.508], [-44, 41.965], [-44, 42], [-43.999, 42.019], [-43.999, 42.077], [-43.998, 42.088], [-43.998, 42.105], [-43.998, 42.113], [-43.998, 42.118], [-43.996, 42.136], [-43.985, 42.288], [-43.983, 42.322], [-43.982, 42.326], [-43.982, 42.331], [-43.981, 42.336], [-43.981, 42.339], [-43.978, 42.356], [-43.977, 42.371], [-43.976, 42.375], [-43.976, 42.378], [-43.969, 42.413], [-43.965, 42.46], [-43.962, 42.475], [-43.962, 42.475], [-43.962, 42.476], [-43.95, 42.534], [-43.943, 42.584], [-43.942, 42.588], [-43.932, 42.628], [-43.931, 42.636], [-43.93, 42.636], [-43.928, 42.647], [-43.924, 42.669], [-43.922, 42.676], [-43.919, 42.693], [-43.917, 42.701], [-43.917, 42.701], [-43.915, 42.711], [-43.914, 42.713], [-43.914, 42.715], [-43.912, 42.722], [-43.899, 42.764], [-43.885, 42.823], [-43.885, 42.824], [-43.885, 42.824], [-43.884, 42.828], [-43.883, 42.831], [-43.882, 42.835], [-43.865, 42.886], [-43.864, 42.89], [-43.86, 42.905], [-43.86, 42.905], [-43.857, 42.915], [-43.855, 42.92], [-43.85, 42.938], [-43.846, 42.949], [-43.845, 42.952], [-43.843, 42.957], [-43.84, 42.967], [-43.84, 42.968], [-43.839, 42.97], [-43.839, 42.971], [-43.838, 42.973], [-43.837, 42.974], [-43.837, 42.976], [-43.82, 43.018], [-43.815, 43.035], [-43.807, 43.059], [-43.807, 43.06], [-43.806, 43.062], [-43.803, 43.068], [-43.799, 43.081], [-43.79, 43.1], [-43.78, 43.123], [-43.773, 43.142], [-43.771, 43.142], [-43.76, 43.172], [-43.751, 43.196], [-43.75, 43.197], [-43.747, 43.206], [-43.746, 43.207], [-43.745, 43.211], [-43.74, 43.221], [-43.735, 43.233], [-43.734, 43.235], [-43.734, 43.235], [-43.734, 43.235], [-43.732, 43.24], [-43.724, 43.255], [-43.708, 43.288], [-43.687, 43.335], [-43.685, 43.338], [-43.684, 43.341], [-43.681, 43.347], [-43.679, 43.351], [-43.676, 43.357], [-43.675, 43.358], [-43.674, 43.359], [-43.674, 43.36], [-43.673, 43.362], [-43.672, 43.364], [-43.667, 43.372], [-43.65, 43.402], [-43.62, 43.462], [-43.613, 43.473], [-43.607, 43.485], [-43.603, 43.492], [-43.599, 43.499], [-43.595, 43.505], [-43.595, 43.505], [-43.578, 43.531], [-43.572, 43.543], [-43.57, 43.543], [-43.57, 43.543], [-43.558, 43.565], [-43.55, 43.58], [-43.549, 43.582], [-43.547, 43.585], [-43.546, 43.587], [-43.54, 43.597], [-43.537, 43.601], [-43.536, 43.603], [-43.534, 43.606], [-43.53, 43.613], [-43.527, 43.617], [-43.526, 43.619], [-43.503, 43.65], [-43.493, 43.665], [-43.464, 43.712], [-43.46, 43.717], [-43.455, 43.725], [-43.446, 43.736], [-43.442, 43.743], [-43.439, 43.747], [-43.437, 43.75], [-43.431, 43.757], [-43.419, 43.772], [-43.406, 43.789], [-43.395, 43.805], [-43.381, 43.825], [-43.379, 43.828], [-43.377, 43.831], [-43.373, 43.836], [-43.371, 43.839], [-43.369, 43.841], [-43.366, 43.844], [-43.365, 43.846], [-43.364, 43.847], [-43.362, 43.85], [-43.347, 43.867], [-43.346, 43.869], [-43.345, 43.87], [-43.345, 43.87], [-43.318, 43.901], [-43.285, 43.944], [-43.283, 43.947], [-43.276, 43.955], [-43.267, 43.964], [-43.262, 43.971], [-43.259, 43.974], [-43.256, 43.978], [-43.241, 43.993], [-43.225, 44.012], [-43.223, 44.012], [-43.196, 44.044], [-43.194, 44.046], [-43.194, 44.046], [-43.193, 44.047], [-43.193, 44.047], [-43.192, 44.048], [-43.192, 44.048], [-43.191, 44.049], [-43.191, 44.049], [-43.19, 44.05], [-43.19, 44.05], [-43.187, 44.053], [-43.174, 44.068], [-43.152, 44.088], [-43.14, 44.1], [-43.1, 44.142], [-43.098, 44.142], [-43.085, 44.157], [-43.085, 44.157], [-43.084, 44.158], [-43.084, 44.158], [-43.083, 44.159], [-43.082, 44.16], [-43.081, 44.161], [-43.071, 44.17], [-43.067, 44.174], [-43.067, 44.174], [-43.066, 44.175], [-43.066, 44.175], [-43.065, 44.176], [-43.042, 44.195], [-43.028, 44.208], [-42.987, 44.248], [-42.983, 44.251], [-42.983, 44.251], [-42.983, 44.251], [-42.98, 44.254], [-42.975, 44.258], [-42.974, 44.259], [-42.974, 44.259], [-42.958, 44.272], [-42.949, 44.28], [-42.913, 44.309], [-42.871, 44.345], [-42.871, 44.345], [-42.863, 44.352], [-42.853, 44.359], [-42.851, 44.361], [-42.833, 44.373], [-42.8, 44.397], [-42.755, 44.433], [-42.754, 44.434], [-42.751, 44.436], [-42.747, 44.439], [-42.744, 44.441], [-42.739, 44.444], [-42.644, 44.507], [-42.611, 44.531], [-42.61, 44.532], [-42.608, 44.533], [-42.606, 44.534], [-42.602, 44.537], [-42.598, 44.539], [-42.597, 44.54], [-42.594, 44.542], [-42.592, 44.543], [-42.588, 44.545], [-42.587, 44.546], [-42.586, 44.547], [-42.584, 44.548], [-42.551, 44.566], [-42.546, 44.57], [-42.544, 44.57], [-42.521, 44.583], [-42.492, 44.602], [-42.489, 44.604], [-42.475, 44.613], [-42.426, 44.637], [-42.404, 44.649], [-42.387, 44.659], [-42.386, 44.659], [-42.356, 44.676], [-42.355, 44.676], [-42.347, 44.681], [-42.346, 44.681], [-42.345, 44.682], [-42.337, 44.686], [-42.333, 44.688], [-42.33, 44.689], [-42.327, 44.691], [-42.325, 44.692], [-42.321, 44.694], [-42.297, 44.704], [-42.273, 44.715], [-42.263, 44.719], [-42.213, 44.744], [-42.155, 44.767], [-42.099, 44.792], [-42.096, 44.793], [-42.092, 44.794], [-42.086, 44.797], [-42.081, 44.799], [-42.078, 44.8], [-42.037, 44.814], [-42.031, 44.816], [-42.005, 44.827], [-41.927, 44.85], [-41.908, 44.857], [-41.824, 44.885], [-41.821, 44.886], [-41.82, 44.886], [-41.82, 44.886], [-41.817, 44.887], [-41.814, 44.888], [-41.81, 44.889], [-41.797, 44.892], [-41.794, 44.893], [-41.773, 44.898], [-41.766, 44.9], [-41.761, 44.9], [-41.755, 44.902], [-41.724, 44.911], [-41.622, 44.933], [-41.548, 44.95], [-41.544, 44.951], [-41.542, 44.951], [-41.538, 44.951], [-41.536, 44.952], [-41.535, 44.952], [-41.531, 44.953], [-41.521, 44.954], [-41.518, 44.955], [-41.489, 44.959], [-41.467, 44.962], [-41.289, 44.986], [-41.267, 44.987], [-41.236, 44.991], [-41.231, 44.991], [-41.225, 44.992], [-41, 45], [-40.551, 45], [-39.951, 45], [-39.351, 45], [-38.751, 45], [-38.151, 45], [-37.551, 45], [-36.951, 45], [-36.351, 45], [-35.751, 45], [-35.151, 45], [28.854, 45], [28.854, 44.964], [28.854, 44.914], [28.854, 44.861], [28.854, 44.804], [28.854, 44.744], [28.854, 44.679], [28.854, 44.611], [28.854, 44.539], [28.854, 44.46], [28.854, 44.377], [28.854, 44.288], [28.854, 44.193], [28.854, 44.089], [28.854, 43.978], [28.854, 43.858], [28.854, 43.728], [28.854, 43.585], [28.854, 43.429], [28.854, 43.258], [28.854, 43.066], [28.854, 42.85], [28.854, 42.603], [28.854, 42.313], [28.854, 41.965], [28.854, 41.513], [28.854, 40.838], [28.854, 37.801], [28.854, 36.901], [28.854, 36.039], [28.854, 35.176], [28.854, 34.314], [28.854, 33.441], [28.854, 32.343], [28.854, 28.69], [28.854, 27.612], [28.854, 26.825], [28.854, 26.038], [28.854, 25.251], [28.854, 24.426], [28.854, 23.236], [28.854, 19.326], [28.854, 18.456], [28.854, 17.728], [28.854, 17.087], [28.854, 16.535], [28.854, 16.025], [28.854, 15.516], [28.854, 15.006], [28.854, 14.496], [28.854, 13.986], [28.854, 13.477], [28.854, 12.967], [28.854, 12.457], [28.854, 11.947], [28.854, 11.438], [28.854, 10.928], [28.854, 10.336], [28.854, 9.69], [28.854, 8.865], [28.854, 7.696], [28.854, 4.126], [28.854, 2.748], [28.854, 1.371], [28.854, -0.007], [28.854, -1.385], [28.854, -2.762], [28.854, -7.773], [28.854, -8.704], [28.854, -9.375], [28.854, -9.932], [28.854, -10.396], [28.854, -10.679], [28.854, -10.817], [28.854, -11.208], [28.854, -11.546], [28.854, -11.879], [28.854, -12.173], [28.854, -12.466], [28.854, -12.726], [28.854, -12.984], [28.854, -13.228], [28.854, -13.456], [28.854, -13.685], [28.854, -13.896], [28.854, -14.1], [28.854, -14.304], [28.854, -14.495], [28.854, -14.679], [28.854, -14.863], [28.854, -15], [26.854, -15], [26.854, -14.865], [26.854, -14.684], [26.854, -14.498], [26.854, -14.304], [26.854, -14.106], [26.854, -13.892], [26.854, -13.678], [26.854, -13.463], [26.854, -13.223], [26.854, -12.978], [26.854, -12.734], [26.854, -12.455], [26.854, -12.172], [26.854, -11.874], [26.854, -11.543], [26.854, -11.206], [26.854, -10.812], [26.854, -10.397], [26.854, -9.914], [26.854, -9.35], [26.854, -8.693], [26.854, -7.792], [26.854, -3.049], [26.854, -1.701], [26.854, -0.354], [26.854, 0.994], [26.854, 2.386], [26.854, 3.89], [26.854, 7.712], [26.854, 8.858], [26.854, 9.644], [26.854, 10.314], [26.854, 10.933], [26.854, 11.435], [26.854, 11.938], [26.854, 12.44], [26.854, 12.943], [26.854, 13.446], [26.854, 13.948], [26.854, 14.451], [26.854, 14.953], [26.854, 15.456], [26.854, 15.966], [26.854, 16.525], [26.854, 17.083], [26.854, 17.722], [26.854, 18.429], [26.854, 19.334], [26.854, 22.665], [25.854, 22.665], [25.854, 19.326], [25.854, 18.456], [25.854, 17.728], [25.854, 17.087], [25.854, 16.535], [25.854, 16.025], [25.854, 15.516], [25.854, 15.006], [25.854, 14.496], [25.854, 13.986], [25.854, 13.477], [25.854, 12.967], [25.854, 12.457], [25.854, 11.947], [25.854, 11.438], [25.854, 10.928], [25.854, 10.336], [25.854, 9.69], [25.854, 8.865], [25.854, 7.696], [25.854, 4.126], [25.854, 2.748], [25.854, 1.371], [25.854, -0.007], [25.854, -1.385], [25.854, -2.762], [25.854, -7.773], [25.854, -8.704], [25.854, -9.375], [25.854, -9.932], [25.854, -10.396], [25.854, -10.679], [25.854, -10.817], [25.854, -11.208], [25.854, -11.546], [25.854, -11.879], [25.854, -12.173], [25.854, -12.466], [25.854, -12.726], [25.854, -12.984], [25.854, -13.228], [25.854, -13.456], [25.854, -13.685], [25.854, -13.896], [25.854, -14.1], [25.854, -14.304], [25.854, -14.495], [25.854, -14.679], [25.854, -14.863], [25.854, -15], [23.854, -15], [23.854, -14.865], [23.854, -14.684], [23.854, -14.498], [23.854, -14.304], [23.854, -14.106], [23.854, -13.892], [23.854, -13.678], [23.854, -13.463], [23.854, -13.223], [23.854, -12.978], [23.854, -12.734], [23.854, -12.455], [23.854, -12.172], [23.854, -11.874], [23.854, -11.543], [23.854, -11.206], [23.854, -10.812], [23.854, -10.397], [23.854, -9.914], [23.854, -9.35], [23.854, -8.693], [23.854, -7.792], [23.854, -3.049], [23.854, -1.701], [23.854, -0.354], [23.854, 0.994], [23.854, 2.386], [23.854, 3.89], [23.854, 7.712], [23.854, 8.858], [23.854, 9.644], [23.854, 10.314], [23.854, 10.933], [23.854, 11.435], [23.854, 11.938], [23.854, 12.44], [23.854, 12.943], [23.854, 13.446], [23.854, 13.948], [23.854, 14.451], [23.854, 14.953], [23.854, 15.456], [23.854, 15.966], [23.854, 16.525], [23.854, 17.083], [23.854, 17.722], [23.854, 18.429], [23.854, 19.334], [23.854, 22.665], [21.854, 22.665], [21.854, 19.326], [21.854, 18.456], [21.854, 17.728], [21.854, 17.087], [21.854, 16.535], [21.854, 16.025], [21.854, 15.516], [21.854, 15.006], [21.854, 14.496], [21.854, 13.986], [21.854, 13.477], [21.854, 12.967], [21.854, 12.457], [21.854, 11.947], [21.854, 11.438], [21.854, 10.928], [21.854, 10.336], [21.854, 9.69], [21.854, 8.865], [21.854, 7.696], [21.854, 4.126], [21.854, 2.748], [21.854, 1.371], [21.854, -0.007], [21.854, -1.385], [21.854, -2.762], [21.854, -7.773], [21.854, -8.704], [21.854, -9.375], [21.854, -9.932], [21.854, -10.396], [21.854, -10.679], [21.854, -10.817], [21.854, -11.208], [21.854, -11.546], [21.854, -11.879], [21.854, -12.173], [21.854, -12.466], [21.854, -12.726], [21.854, -12.984], [21.854, -13.228], [21.854, -13.456], [21.854, -13.685], [21.854, -13.896], [21.854, -14.1], [21.854, -14.304], [21.854, -14.495], [21.854, -14.679], [21.854, -14.863], [21.854, -15], [19.854, -15], [19.854, -14.865], [19.854, -14.684], [19.854, -14.498], [19.854, -14.304], [19.854, -14.106], [19.854, -13.892], [19.854, -13.678], [19.854, -13.463], [19.854, -13.223], [19.854, -12.978], [19.854, -12.734], [19.854, -12.455], [19.854, -12.172], [19.854, -11.874], [19.854, -11.543], [19.854, -11.206], [19.854, -10.812], [19.854, -10.397], [19.854, -9.914], [19.854, -9.35], [19.854, -8.693], [19.854, -7.792], [19.854, -3.049], [19.854, -1.701], [19.854, -0.354], [19.854, 0.994], [19.854, 2.386], [19.854, 3.89], [19.854, 7.712], [19.854, 8.858], [19.854, 9.644], [19.854, 10.314], [19.854, 10.933], [19.854, 11.435], [19.854, 11.938], [19.854, 12.44], [19.854, 12.943], [19.854, 13.446], [19.854, 13.948], [19.854, 14.451], [19.854, 14.953], [19.854, 15.456], [19.854, 15.966], [19.854, 16.525], [19.854, 17.083], [19.854, 17.722], [19.854, 18.429], [19.854, 19.334], [19.854, 22.665], [16.854, 22.665], [16.854, 19.326], [16.854, 18.456], [16.854, 17.728], [16.854, 17.087], [16.854, 16.535], [16.854, 16.025], [16.854, 15.516], [16.854, 15.006], [16.854, 14.496], [16.854, 13.986], [16.854, 13.477], [16.854, 12.967], [16.854, 12.457], [16.854, 11.947], [16.854, 11.438], [16.854, 10.928], [16.854, 10.336], [16.854, 9.69], [16.854, 8.865], [16.854, 7.696], [16.854, 4.126], [16.854, 2.748], [16.854, 1.371], [16.854, -0.007], [16.854, -1.385], [16.854, -2.762], [16.854, -7.773], [16.854, -8.704], [16.854, -9.375], [16.854, -9.932], [16.854, -10.396], [16.854, -10.679], [16.854, -10.817], [16.854, -11.208], [16.854, -11.546], [16.854, -11.879], [16.854, -12.173], [16.854, -12.466], [16.854, -12.726], [16.854, -12.984], [16.854, -13.228], [16.854, -13.456], [16.854, -13.685], [16.854, -13.896], [16.854, -14.1], [16.854, -14.304], [16.854, -14.495], [16.854, -14.679], [16.854, -14.863], [16.854, -15], [14.854, -15], [14.854, -14.865], [14.854, -14.684], [14.854, -14.498], [14.854, -14.304], [14.854, -14.106], [14.854, -13.892], [14.854, -13.678], [14.854, -13.463], [14.854, -13.223], [14.854, -12.978], [14.854, -12.734], [14.854, -12.455], [14.854, -12.172], [14.854, -11.874], [14.854, -11.543], [14.854, -11.206], [14.854, -10.812], [14.854, -10.397], [14.854, -9.914], [14.854, -9.35], [14.854, -8.693], [14.854, -7.792], [14.854, -3.049], [14.854, -1.701], [14.854, -0.354], [14.854, 0.994], [14.854, 2.386], [14.854, 3.89], [14.854, 7.712], [14.854, 8.858], [14.854, 9.644], [14.854, 10.314], [14.854, 10.933], [14.854, 11.435], [14.854, 11.938], [14.854, 12.44], [14.854, 12.943], [14.854, 13.446], [14.854, 13.948], [14.854, 14.451], [14.854, 14.953], [14.854, 15.456], [14.854, 15.966], [14.854, 16.525], [14.854, 17.083], [14.854, 17.722], [14.854, 18.429], [14.854, 19.334], [14.854, 22.665], [10.854, 22.665], [10.854, 19.326], [10.854, 18.456], [10.854, 17.728], [10.854, 17.087], [10.854, 16.535], [10.854, 16.025], [10.854, 15.516], [10.854, 15.006], [10.854, 14.496], [10.854, 13.986], [10.854, 13.477], [10.854, 12.967], [10.854, 12.457], [10.854, 11.947], [10.854, 11.438], [10.854, 10.928], [10.854, 10.336], [10.854, 9.69], [10.854, 8.865], [10.854, 7.696], [10.854, 4.126], [10.854, 2.748], [10.854, 1.371], [10.854, -0.007], [10.854, -1.385], [10.854, -2.762], [10.854, -7.773], [10.854, -8.704], [10.854, -9.375], [10.854, -9.932], [10.854, -10.396], [10.854, -10.679], [10.854, -10.817], [10.854, -11.208], [10.854, -11.546], [10.854, -11.879], [10.854, -12.173], [10.854, -12.466], [10.854, -12.726], [10.854, -12.984], [10.854, -13.228], [10.854, -13.456], [10.854, -13.685], [10.854, -13.896], [10.854, -14.1], [10.854, -14.304], [10.854, -14.495], [10.854, -14.679], [10.854, -14.863], [10.854, -15], [8.854, -15], [8.854, -14.865], [8.854, -14.684], [8.854, -14.498], [8.854, -14.304], [8.854, -14.106], [8.854, -13.892], [8.854, -13.678], [8.854, -13.463], [8.854, -13.223], [8.854, -12.978], [8.854, -12.734], [8.854, -12.455], [8.854, -12.172], [8.854, -11.874], [8.854, -11.543], [8.854, -11.206], [8.854, -10.812], [8.854, -10.397], [8.854, -9.914], [8.854, -9.35], [8.854, -8.693], [8.854, -7.792], [8.854, -3.049], [8.854, -1.701], [8.854, -0.354], [8.854, 0.994], [8.854, 2.386], [8.854, 3.89], [8.854, 7.712], [8.854, 8.858], [8.854, 9.644], [8.854, 10.314], [8.854, 10.933], [8.854, 11.435], [8.854, 11.938], [8.854, 12.44], [8.854, 12.943], [8.854, 13.446], [8.854, 13.948], [8.854, 14.451], [8.854, 14.953], [8.854, 15.456], [8.854, 15.966], [8.854, 16.525], [8.854, 17.083], [8.854, 17.722], [8.854, 18.429], [8.854, 19.334], [8.854, 22.665], [3.854, 22.665], [3.854, 19.326], [3.854, 18.456], [3.854, 17.728], [3.854, 17.087], [3.854, 16.535], [3.854, 16.025], [3.854, 15.516], [3.854, 15.006], [3.854, 14.496], [3.854, 13.986], [3.854, 13.477], [3.854, 12.967], [3.854, 12.457], [3.854, 11.947], [3.854, 11.438], [3.854, 10.928], [3.854, 10.336], [3.854, 9.69], [3.854, 8.865], [3.854, 7.696], [3.854, 4.126], [3.854, 2.748], [3.854, 1.371], [3.854, -0.007], [3.854, -1.385], [3.854, -2.762], [3.854, -7.773], [3.854, -8.704], [3.854, -9.375], [3.854, -9.932], [3.854, -10.396], [3.854, -10.679], [3.854, -10.817], [3.854, -11.208], [3.854, -11.546], [3.854, -11.879], [3.854, -12.173], [3.854, -12.466], [3.854, -12.726], [3.854, -12.984], [3.854, -13.228], [3.854, -13.456], [3.854, -13.685], [3.854, -13.896], [3.854, -14.1], [3.854, -14.304], [3.854, -14.495], [3.854, -14.679], [3.854, -14.863], [3.854, -15], [1.854, -15], [1.854, -14.865], [1.854, -14.684], [1.854, -14.498], [1.854, -14.304], [1.854, -14.106], [1.854, -13.892], [1.854, -13.678], [1.854, -13.463], [1.854, -13.223], [1.854, -12.978], [1.854, -12.734], [1.854, -12.455], [1.854, -12.172], [1.854, -11.874], [1.854, -11.543], [1.854, -11.206], [1.854, -10.812], [1.854, -10.397], [1.854, -9.914], [1.854, -9.35], [1.854, -8.693], [1.854, -7.792], [1.854, -3.049], [1.854, -1.701], [1.854, -0.354], [1.854, 0.994], [1.854, 2.386], [1.854, 3.89], [1.854, 7.712], [1.854, 8.858], [1.854, 9.644], [1.854, 10.314], [1.854, 10.933], [1.854, 11.435], [1.854, 11.938], [1.854, 12.44], [1.854, 12.943], [1.854, 13.446], [1.854, 13.948], [1.854, 14.451], [1.854, 14.953], [1.854, 15.456], [1.854, 15.966], [1.854, 16.525], [1.854, 17.083], [1.854, 17.722], [1.854, 18.429], [1.854, 19.334], [1.854, 22.665], [-4.146, 22.665], [-4.146, 19.346], [-4.146, 18.417], [-4.146, 17.745], [-4.146, 17.072], [-4.146, 16.55], [-4.146, 16.032], [-4.146, 15.515], [-4.146, 14.998], [-4.146, 14.48], [-4.146, 14.088], [-4.146, 13.624], [-4.146, 13.16], [-4.146, 12.696], [-4.146, 12.232], [-4.146, 11.769], [-4.146, 11.305], [-4.146, 10.841], [-4.146, 10.377], [-4.146, 9.913], [-4.146, 9.449], [-4.146, 8.985], [-4.146, 8.521], [-4.146, 8.36], [-4.146, 8.183], [-4.146, 8.007], [-4.146, 7.831], [-4.146, 7.655], [-4.146, 7.479], [-4.146, 7.302], [-4.146, 7.126], [-4.146, 6.95], [-4.146, 6.774], [-4.146, 6.598], [-4.146, 6.421], [-4.146, 6.245], [-4.146, 6.069], [-4.146, 5.893], [-4.146, 5.717], [-4.146, 5.541], [-4.146, 5.364], [-4.146, 5.188], [-4.146, 5.012], [-4.146, 4.836], [-4.146, 4.66], [-4.146, 4.483], [-4.146, 4.307], [-4.146, 4.014], [-4.146, 2.656], [-4.146, 1.298], [-4.146, -0.061], [-4.146, -1.355], [-4.146, -2.643], [-4.146, -7.773], [-4.146, -8.705], [-4.146, -9.375], [-4.146, -9.932], [-4.146, -10.396], [-4.146, -10.817], [-4.146, -11.208], [-4.146, -11.546], [-4.146, -11.879], [-4.146, -12.173], [-4.146, -12.466], [-4.146, -12.726], [-4.146, -12.984], [-4.146, -13.228], [-4.146, -13.456], [-4.146, -13.685], [-4.146, -13.896], [-4.146, -14.1], [-4.146, -14.304], [-4.146, -14.495], [-4.146, -14.679], [-4.146, -14.863], [-4.146, -15], [-35.151, -15], [-35.751, -15], [-36.351, -15], [-36.951, -15], [-37.551, -15], [-38.151, -15], [-38.751, -15], [-39.351, -15], [-39.951, -15], [-40.551, -15], [-41, -14.845], [-44, -13.896], [-44, -13.679], [-44, -13.462], [-44, -13.226], [-44, -12.981], [-44, -12.734], [-44, -12.457], [-44, -12.179], [-44, -11.871], [-44, -11.552], [-44, -11.197], [-44, -10.828], [-44, -10.395], [-44, -9.918], [-44, -9.37], [-44, -8.693], [-44, -7.774], [-44, -2.74], [-44, -1.273], [-44, -0.069], [-44, 1.135], [-44, 2.34], [-44, 4.031], [-44, 7.703], [-44, 8.856], [-44, 9.678], [-44, 10.34], [-44, 10.933], [-44, 11.479], [-44, 12.025], [-44, 12.532], [-44, 13.033], [-44, 13.534], [-44, 14.035], [-44, 14.536], [-44, 15.038], [-44, 15.539], [-44, 16.04]]

z_tool_path = []

for i in toolpath:
    z_tool_path.append([i[0], i[1], -8])


# 4. 检测
collisions = check_toolpath(
    zmap,
    z_tool_path,
    shank_len=0,
    shank_radius=tool_radius,
    clearance=0.1
)

t2 = time.time()
print(t2-t1)
print(collisions)
# Build surface for visualization
# xs = np.linspace(zmap.xmin, zmap.xmin + (zmap.nx - 1) * zmap.step, zmap.nx)
# ys = np.linspace(zmap.ymin, zmap.ymin + (zmap.ny - 1) * zmap.step, zmap.ny)
# X, Y = np.meshgrid(xs, ys, indexing="ij")
# Z = zmap.z.copy()
# Z[Z < -1e8] = np.nan
#
# # Plot
# fig = plt.figure()
# ax = fig.add_subplot(111, projection="3d")
# ax.plot_surface(X, Y, Z, rstride=1, cstride=1, linewidth=0, antialiased=False)
# toolpath = np.array(toolpath)
# ax.plot(toolpath[:,0], toolpath[:,1], toolpath[:,2], marker='o')
#
# ax.set_xlabel("X")
# ax.set_ylabel("Y")
# ax.set_zlabel("Z")
# plt.show()

